{# templates/credential/new.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Ajouter un identifiant{% endblock %}

{% block body %}
<div class="container py-5">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ path('credential_index') }}">Mes identifiants</a></li>
            <li class="breadcrumb-item active" aria-current="page">Ajouter un identifiant</li>
        </ol>
    </nav>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h1 class="h4 mb-0">Ajouter un nouvel identifiant</h1>
                </div>
                <div class="card-body">
                    {{ form_start(form) }}
                    <div class="mb-3">
                        {{ form_label(form.name) }}
                        {{ form_widget(form.name) }}
                        {{ form_errors(form.name) }}
                        {{ form_help(form.name) }}
                    </div>
                    
                    <div class="mb-3">
                        {{ form_label(form.domain) }}
                        {{ form_widget(form.domain) }}
                        {{ form_errors(form.domain) }}
                        <div class="form-text">{{ form_help(form.domain) }}</div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form_label(form.username) }}
                        {{ form_widget(form.username) }}
                        {{ form_errors(form.username) }}
                        {{ form_help(form.username) }}
                    </div>
                    
                    <div class="mb-3">
                        {{ form_label(form.password) }}
                        <div class="input-group">
                            {{ form_widget(form.password) }}
                            <button type="button" class="btn btn-outline-secondary toggle-password">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary generate-password">
                                <i class="fas fa-key me-1"></i> Générer
                            </button>
                        </div>
                        {{ form_errors(form.password) }}
                        {{ form_help(form.password) }}
                        <div class="password-strength mt-2 d-none">
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted password-feedback mt-1 d-block"></small>
                        </div>
                    </div>
                    
                    {{ form_rest(form) }}
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ path('credential_index') }}" class="btn btn-outline-secondary">Annuler</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Enregistrer
                        </button>
                    </div>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>
    </div>
</div>

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Afficher/masquer le mot de passe
    const togglePasswordBtn = document.querySelector('.toggle-password');
    if (togglePasswordBtn) {
        togglePasswordBtn.addEventListener('click', function() {
            const passwordInput = document.querySelector('#credential_password');
            const icon = this.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    }
    
    // Générer un mot de passe aléatoire
    const generatePasswordBtn = document.querySelector('.generate-password');
    if (generatePasswordBtn) {
        generatePasswordBtn.addEventListener('click', function() {
            const passwordInput = document.querySelector('#credential_password');
            const passwordLength = 16;
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+{}[]|:;<>,.?/';
            
            let password = '';
            // Assurer qu'il y a au moins une lettre minuscule, une majuscule, un chiffre et un caractère spécial
            password += charset.match(/[a-z]/)[0];
            password += charset.match(/[A-Z]/)[0];
            password += charset.match(/[0-9]/)[0];
            password += charset.match(/[^a-zA-Z0-9]/)[0];
            
            // Compléter avec des caractères aléatoires
            for (let i = 4; i < passwordLength; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            
            // Mélanger le mot de passe
            password = password.split('').sort(() => 0.5 - Math.random()).join('');
            
            passwordInput.value = password;
            passwordInput.type = 'text';
            const toggleBtn = document.querySelector('.toggle-password');
            const icon = toggleBtn.querySelector('i');
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
            
            // Analyser la force du mot de passe
            checkPasswordStrength(password);
        });
    }
    
    // Vérifier la force du mot de passe
    const passwordInput = document.querySelector('#credential_password');
    const strengthElement = document.querySelector('.password-strength');
    const progressBar = document.querySelector('.password-strength .progress-bar');
    const feedbackElement = document.querySelector('.password-feedback');
    
    if (passwordInput && strengthElement && progressBar && feedbackElement) {
        passwordInput.addEventListener('input', function() {
            strengthElement.classList.remove('d-none');
            checkPasswordStrength(this.value);
        });
    }
    
    function checkPasswordStrength(password) {
        let strength = 0;
        let feedback = '';
        
        if (password.length < 8) {
            strength = 10;
            feedback = 'Très faible : Utilisez au moins 8 caractères';
        } else {
            strength = 25;
            feedback = 'Faible : ';
            
            if (password.length >= 12) strength += 15;
            if (password.match(/[A-Z]/)) {
                strength += 10;
            } else {
                feedback += 'Ajoutez une majuscule. ';
            }
            
            if (password.match(/[a-z]/)) {
                strength += 10;
            } else {
                feedback += 'Ajoutez une minuscule. ';
            }
            
            if (password.match(/[0-9]/)) {
                strength += 10;
            } else {
                feedback += 'Ajoutez un chiffre. ';
            }
            
            if (password.match(/[^A-Za-z0-9]/)) {
                strength += 10;
            } else {                feedback += 'Ajoutez un caractère spécial. ';
            }

            if (strength >= 80) {
                feedback = 'Fort';
            } else if (strength >= 60) {
                feedback = 'Moyen : ' + feedback;
            } else {
                feedback = 'Faible : ' + feedback;
            }
        }

        progressBar.style.width = strength + '%';

        if (strength < 40) {
            progressBar.className = 'progress-bar bg-danger';
        } else if (strength < 70) {
            progressBar.className = 'progress-bar bg-warning';
        } else {
            progressBar.className = 'progress-bar bg-success';
        }

        feedbackElement.textContent = feedback;
    }
});
</script>
{% endblock %}
{% endblock %}
